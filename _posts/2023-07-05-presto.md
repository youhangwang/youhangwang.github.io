---
title: Presto Overview
tags: Presto
---

## Presto 是什么

不要因为 Presto 提供了标准数据库的功能就误认为 Presto 理解 SQL。 Presto 不是通用的关系数据库。它不能替代 MySQL、PostgreSQL 或 Oracle 等数据库。 Presto 并不是为处理在线事务处理 (OLTP) 而设计的。

Presto 是一款旨在使用分布式查询以高效查询大量数据的工具。如果处理的数据是 TB 或 PB 量级，可能会使用与 Hadoop 和 HDFS 交互的工具。 Presto 被设计为使用 Hive 或 Pig 等 MapReduce pipelines 查询 HDFS 的工具，但 Presto 不仅仅限于访问 HDFS。 Presto 还可以在其他不同类型的数据源上运行，包括传统关系数据库和 Cassandra 等其他数据源。

Presto 旨在处理data warehousing和analytics：数据分析、聚合大量数据并生成报告。这些工作负载通常被归类为在线分析处理 (OLAP)。

## Concepts

语句和查询很容易理解，作为最终用户，还应该熟悉Stages和Splits等概念，以充分利用 Presto 执行高效的查询。作为 Presto 管理员或 Presto 贡献者，应该了解 Presto 的Stage概念如何映射到task以及task如何包含一组处理数据的drivers。

### Server Types

Presto 服务器分为三种类型：
- resource manager
- coordinators
- workers

#### Resource Manager


Presto Resource Manager是聚合来自所有coordinators和workers的数据并构建集群全局视图的服务器。具有 disaggregated coordinators 的 Presto 安装必须需要Resource Manager。集群支持多个Resource Manager，每个Resource Manager都充当主Resource Manager。

coordinators和workers使用 Thrift API 与Resource Manager进行通信。

#### Coordinator

Presto Coordinator 是负责解析语句、规划查询和管理Presto工作节点的服务器。它是 Presto 安装的“大脑”，也是客户端连接以提交执行语句的节点。每个 Presto 安装都必须有一名 Presto Coordinator 和一名或多名 Presto Worker。出于开发或测试目的，可以将单个 Presto 实例配置为执行这两个角色。

Coordinator 跟踪每个 Worker 的活动并协调查询的执行。 Coordinator 创建涉及一系列Stages的查询的逻辑模型，然后将其转换为在 Presto 工作集群上运行的一系列connected tasks。

Coordinator 使用 REST API 与 Worker 和 Client 进行通信。

#### Worker

Presto Worker 是 Presto 安装中的server，负责执行 Task 和处理数据。 Worker node 从 connectors 获取数据并相互交换中间数据。 Coordinator 负责从Worker 那里获取结果并将最终结果返回给客户端。

当 Presto worker启动时，它会将自己通告给 Coordinator 中的 discovery 服务器，这使其可供 Presto Coordinator 执行 Task 。

worker 使用 REST API 与其他 worker 和 Presto Coordinator 进行通信。

### Data Sources

connector, catalog, schema, and table这些基本概念涵盖了特定数据源的 Presto 模型，并在以下部分中进行了描述。

#### Connector

Connector 使 Presto 适应 Hive 或关系数据库等数据源。可以像考虑数据库 driver 一样来考虑Connector。它是 Presto SPI 的实现，允许 Presto 使用标准 API 与资源交互。

Presto 包含多个内置 Connector：用于 JMX 的 Connector、提供对内置系统表的访问的System Connector 、Hive  Connector 以及设计用于提供 TPC-H 基准数据的 TPCH  Connector 。许多第三方开发人员贡献了 Connector ，以便 Presto 可以访问各种数据源中的数据。

每个 catalog 都与特定的 Connector 相关联。如果检查 catalog 配置文件，将看到每个配置文件都包含一个强制属性connector.name，catalog manager使用该属性为给定 catalog 创建 Connector 。可以让多个 catalog 使用相同的 Connector 来访问相似数据库的两个不同实例。例如，如果您有两个 Hive 集群，则可以在单个 Presto 集群中配置两个 catalog，这两个目录都使用 Hive Connector ，从而允许您从两个 Hive 集群查询数据（即使在同一 SQL 查询中）。

#### Catalog

Presto catalog 包含 schemas 并通过 Connector 引用数据源。例如，可以配置 JMX Catalog 以通过 JMX Connector 提供对 JMX 信息的访问。在 Presto 中运行 SQL 语句时，是针对一个或多个 catalog 运行它。catalog 的其他示例包括用于连接到 Hive 数据源的 Hive catalog。

在 Presto 中addressing table时，fully-qualified 的表名称始终植根于一个 catalog 中。例如，fully-qualified 表名称 hive.test_data.test 将引用 hive catalog 中 test_data scheme中的测试表。Catalog 在 Presto 配置目录中的属性文件中定义。

#### Schema

Schema 是一种组织表格的方法。Catalog 和 Schema 一起定义了一组可以查询的表。当使用 Presto 访问 Hive 或 MySQL 等关系数据库时，schema 会转换为目标数据库中的相同概念。其他类型的Connector可能会选择以对底层数据源有意义的方式将表组织到 Schema 中。

#### Table

表是一组无序的行，它们被组织成具有类型的命名列。这与任何关系数据库中的情况相同。从源数据到表的映射由 Connector 定义。

### Query Execution Model

Presto 执行 SQL 语句并将这些语句转换为跨Coordinator和Worker的分布式集群执行的查询

#### Statement

Presto 执行 ANSI 兼容的 SQL 语句。当 Presto 文档引用语句时，它指的是 ANSI SQL 标准中定义的语句，其中包含子句、表达式和谓词。

有些读者可能会好奇为什么本节列出了 Statement 和 Query 的单独概念。这是必要的，因为在 Presto 中，语句仅代表 SQL 语句的文本表示。执行语句时，Presto 会创建一个 Query 以及一个 Query Plan，然后将其分发到一系列 Presto workers中。

#### Query

当 Presto 解析语句时，它将其转换为 Query 并创建分布式 Query Plan，然后将其实现为在 Presto Worker 上运行的一系列 interconnected stages。当在 Presto 中检索有关Query的信息时，会收到参与生成响应语句的结果集的每个组件的快照。

语句和查询之间的区别很简单。语句可以被认为是传递给 Presto 的 SQL 文本，而查询是指为执行该语句而实例化的配置和组件。查询包含Stage、Task、 Splits、Connectors以及协同工作以产生结果的其他组件和数据源。

#### Stage

当 Presto 执行查询时，它通过将执行分解为分层的Stage结构来实现。例如，如果 Presto 需要聚合 Hive 中存储的 10 亿行数据，它会通过创建一个root stage来聚合其他几个stage的输出来实现这一目的，所有这些stage都旨在实现分布式查询计划的不同部分。

组成查询的阶段层次结构类似于树。每个查询都有一个root stage，负责聚合其他stage的输出。Coordinator使用stage来建模分布式查询计划，但stage本身并不在 Presto worker上运行。

#### Task

正如上一节中提到的，Stage对分布式查询计划的特定部分进行建模，但Stage本身并不在 Presto Worker 上执行。要了解Stage是如何执行的，需要了解Stage是作为分布在 Presto Worker网络上的一系列Task来实现的。

Task是 Presto 架构中的 “work horse”，因为分布式查询计划被解构为一系列Stage，然后将这些Stage转换为Task，然后对Task进行操作或Splits。 Presto  Task 具有输入和输出，正如一个Stage可以由一系列task并行执行一样，task 也可以与一系列drivers并行执行。


#### Split

Task 对 Splits 进行操作， Split 是较大数据集的一部分。分布式查询计划最低级别的 Stage 通过Connector的 Split 检索数据，分布式查询计划较高级别的中间Stage从其他Stage检索数据。

当 Presto 调度查询时， coordinator 将查询 Connector 以获取可用于表的所有 Splits 的列表。 coordinator 跟踪哪些机器正在运行哪些 Task 以及哪些 Task 正在处理哪些Split。

#### Driver

Task 包含一个或多个并行 Driver。 Driver对数据进行操作并组合运算以生成输出，然后由Task聚合该输出，然后将其传递给另一个Stage的另一个Task。 Driver  是一系列运算实例，或者可以将 Driver 视为内存中的一组物理运算器。它是 Presto 架构中最低级别的并行性。Driver有一个输入和一个输出。

#### Operator

Operator消费、转换和生成数据。例如，表扫描从 Connector 获取数据并生成可由其他Operator使用的数据，而过滤 Operator 使用数据并通过对输入数据应用谓词来生成子集。

#### Exchange 

Exchange 在 Presto 节点之间传输数据以进行查询的不同 Stage。Task 将数据生成到输出缓冲区中，并使用Exchange客户端消耗来自其他Task的数据